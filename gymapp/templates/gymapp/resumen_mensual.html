{% extends "gymapp/base.html" %}
{% block title %}Resumen mensual{% endblock %}
{% block content %}

<h2 class="page-title mb-3">Resumen mensual</h2>

<form method="get" class="mes-picker">
  <div>
    <label class="form-label">Mes</label>
    <input type="month" class="form-control" name="mes" value="{{ mes|date:'Y-m' }}">
  </div>
  <button class="btn btn-primary mb-1"><i class="bi bi-search me-1"></i>Ver</button>
</form>

<div class="resumen-header mb-3 d-flex justify-content-between align-items-center">
  <div class="d-flex align-items-center gap-3">
    <span class="badge bg-info text-dark fw-semibold">Mes: {{ mes|date:"m/Y" }}</span>
  </div>
  <div class="resumen-total fs-5">Total: ${{ total_general|floatformat:0 }}</div>
</div>

<!-- KPIs por plan -->
<div class="resumen-kpis">
  {% for item in datos %}
    <div class="kpi">
      <p class="kpi__title">{{ item.nombre }}</p>
      <p class="kpi__value">${{ item.subtotal|default_if_none:0|floatformat:0 }}</p>
      <p class="text-muted m-0">Pagos: <strong>{{ item.cantidad }}</strong></p>
    </div>
  {% endfor %}
</div>

<!-- Tabla de totales por plan -->
<div class="table-responsive mt-3">
  <table class="table table-dark table-striped table-hover align-middle">
    <thead>
      <tr>
        <th style="width:40%">Plan</th>
        <th style="width:20%" class="text-center">Cantidad</th>
        <th style="width:40%" class="text-end">Subtotal</th>
      </tr>
    </thead>
    <tbody>
      {% for item in datos %}
      <tr>
        <td>{{ item.nombre }}</td>
        <td class="text-center">{{ item.cantidad }}</td>
        <td class="text-end">${{ item.subtotal|default_if_none:0|floatformat:0 }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="3" class="text-center">Sin pagos registrados para este mes.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Lista de pagos del mes con botón Anular -->
<div class="table-responsive mt-4">
  <h5 class="mb-2">Pagos del mes</h5>
    <table class="table table-dark table-striped table-hover align-middle">
    <thead>
      <tr>
        <th>Socio</th>
        <th>Plan</th>
        <th class="text-end">Monto</th>
        <th>Estado</th>
        <th class="text-center">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for p in pagos_list %}
      <tr>
        <td>{{ p.member.nombre_apellido }}</td>
        <td>{{ p.get_plan_display|default:"—" }}</td>
        <td class="text-end">${{ p.monto|floatformat:0 }}</td>
        <td>
          {% if p.pagado %}
            <span class="badge bg-success">Pagado</span>
          {% else %}
            <span class="badge bg-danger">Debe</span>
          {% endif %}
        </td>
        <td class="text-center">
          <!-- Botón para anular el pago completamente (anulado=True) -->
          <form method="post" action="{% url 'eliminar_pago' p.id %}" style="display:inline;" onsubmit="return confirm('¿Anular pago de {{ p.member.nombre_apellido }} ({{ mes|date:"m/Y" }})?');">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-danger me-1">
              <i class="bi bi-x-circle me-1"></i> Anular
            </button>
          </form>
          <!-- Botón para cambiar estado de pagado/debe del pago con plan -->
          <form method="post" action="{% url 'toggle_payment_mes' p.member.id p.mes|date:'m-Y' %}" style="display:inline;">
            {% csrf_token %}
            <button class="btn btn-sm {% if p.pagado %}btn-outline-warning{% else %}btn-outline-success{% endif %}">
              {% if p.pagado %}
                Marcar como debe
              {% else %}
                Marcar pagado
              {% endif %}
            </button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" class="text-center">No hay pagos registrados con plan para este mes.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<p class="resumen-nota mt-2">
  * El total solo suma pagos con <strong>plan</strong>, que no estén <strong>anulados</strong> y que estén marcados como <strong>pagados</strong>.<br>
  Los pagos marcados rápido con “Debe/Pagado” no se suman hasta que se registre un plan y se marque como pagado en el historial.
</p>


{% endblock %}
